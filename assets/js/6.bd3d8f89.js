(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{267:function(t,e,s){t.exports=s.p+"assets/img/portal_create_container_explorer.b243a13a.png"},436:function(t,e,s){t.exports=s.p+"assets/img/resourcemodel.1ea193f0.png"},437:function(t,e,s){t.exports=s.p+"assets/img/portal_create_api_option.88c40547.png"},438:function(t,e,s){t.exports=s.p+"assets/img/portal_create_overview.8d5ee124.png"},439:function(t,e,s){t.exports=s.p+"assets/img/portal_create_container.7472740c.png"},440:function(t,e,s){t.exports=s.p+"assets/img/portal_dataexplorer_upload.e84edfb3.png"},441:function(t,e,s){t.exports=s.p+"assets/img/portal_dataexplorer_newquery.528b80a0.png"},442:function(t,e,s){t.exports=s.p+"assets/img/portal_dataexplorer_results.5885c78f.png"},443:function(t,e,s){t.exports=s.p+"assets/img/document_tree.af75dc1b.png"},444:function(t,e,s){t.exports=s.p+"assets/img/changefeedoverview.f37a73b3.png"},445:function(t,e,s){t.exports=s.p+"assets/img/functions.d5a047bf.png"},446:function(t,e,s){t.exports=s.p+"assets/img/changefeedvisual.216222cf.png"},447:function(t,e,s){t.exports=s.p+"assets/img/portal_create_customer.b1a9c666.png"},448:function(t,e,s){t.exports=s.p+"assets/img/breakpointchangefeed.e0a508be.png"},449:function(t,e,s){t.exports=s.p+"assets/img/portal_customerview_result.44db7b99.png"},450:function(t,e,s){t.exports=s.p+"assets/img/portal_insights1.441112c5.png"},451:function(t,e,s){t.exports=s.p+"assets/img/portal_insights2.8da090cf.png"},452:function(t,e,s){t.exports=s.p+"assets/img/portal_insights3.f6f01cc5.png"},752:function(t,e,s){"use strict";s.r(e);var a=s(10),r=Object(a.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"challenge-01-cosmos-db"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#challenge-01-cosmos-db"}},[t._v("#")]),t._v(" Challenge 01: Cosmos DB")]),t._v(" "),e("p",[t._v("‚è≤Ô∏è "),e("em",[t._v("Est. time to complete: 60 min.")]),t._v(" ‚è≤Ô∏è")]),t._v(" "),e("h2",{attrs:{id:"here-is-what-you-will-learn-üéØ"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#here-is-what-you-will-learn-üéØ"}},[t._v("#")]),t._v(" Here is what you will learn üéØ")]),t._v(" "),e("p",[t._v("In this challenge you will learn how to:")]),t._v(" "),e("ul",[e("li",[t._v("Create a Cosmos DB account")]),t._v(" "),e("li",[t._v("Add data and query via the data explorer")]),t._v(" "),e("li",[t._v("Learn about partitions and the effect of cross-partition queries")]),t._v(" "),e("li",[t._v("Use the Cosmos DB change feed")]),t._v(" "),e("li",[t._v("Monitor your database")])]),t._v(" "),e("h2",{attrs:{id:"table-of-contents"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#table-of-contents"}},[t._v("#")]),t._v(" Table Of Contents")]),t._v(" "),e("ol",[e("li",[e("a",{attrs:{href:"#create-a-comsos-db-account-database-and-containers"}},[t._v("Create a Comsos DB Account, Database and Containers")])]),t._v(" "),e("li",[e("a",{attrs:{href:"#add-and-query-data"}},[t._v("Add and query data")])]),t._v(" "),e("li",[e("a",{attrs:{href:"#use-the-cosmos-db-change-feed"}},[t._v("Use the Cosmos DB Change Feed")])]),t._v(" "),e("li",[e("a",{attrs:{href:"#monitor-cosmos-db"}},[t._v("Monitor Cosmos DB")])]),t._v(" "),e("li",[e("a",{attrs:{href:"#azure-samples"}},[t._v("Azure Samples")])]),t._v(" "),e("li",[e("a",{attrs:{href:"#cleanup"}},[t._v("Cleanup")])])]),t._v(" "),e("h2",{attrs:{id:"create-a-comsos-db-account-database-and-containers"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#create-a-comsos-db-account-database-and-containers"}},[t._v("#")]),t._v(" Create a Comsos DB Account, Database and Containers")]),t._v(" "),e("p",[t._v("Before we start creating a database account in Azure, let's have a brief look at the resource model of Cosmos DB. It is made of the following objects:")]),t._v(" "),e("ul",[e("li",[e("em",[t._v("Account")]),t._v(": manages one or more databases")]),t._v(" "),e("li",[e("em",[t._v("Database")]),t._v(": manages users, permissions and containers")]),t._v(" "),e("li",[e("em",[t._v("Container")]),t._v(": a schema-agnostic container of user-generated JSON items and JavaScript based stored procedures, triggers and user-defined-functions (UDFs)")]),t._v(" "),e("li",[e("em",[t._v("Item")]),t._v(": user-generated document stored in a container")])]),t._v(" "),e("p",[e("img",{attrs:{src:s(436),alt:"Cosmos DB Resource Model",title:"Comsos DB Resource Model"}})]),t._v(" "),e("p",[t._v("To create a Cosmos DB account, database and the corresponding containers we will use in this challenge, you have two options:")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"#option-1-azure-portal"}},[t._v("Azure Portal")])]),t._v(" "),e("li",[e("a",{attrs:{href:"#option-2-azure-bicep"}},[t._v("Azure Bicep")])])]),t._v(" "),e("p",[t._v("Both are decribed in the next chapters, choose only one of them.")]),t._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),e("p",[t._v('üìù The "Bicep" option is much faster, because it will create all the objects automatically at once. If you want to go with that one, please also have a look at the "Create View" in the portal to make yourself familiar with all the settings you can adjust for a Cosmos DB account, db and container.')])]),t._v(" "),e("h3",{attrs:{id:"option-1-azure-portal"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#option-1-azure-portal"}},[t._v("#")]),t._v(" Option 1: Azure Portal")]),t._v(" "),e("h4",{attrs:{id:"create-a-comsos-db-account"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#create-a-comsos-db-account"}},[t._v("#")]),t._v(" Create a Comsos DB Account")]),t._v(" "),e("p",[t._v("In the Azure Portal, click on "),e("em",[t._v("Create Resource")]),t._v(" and select "),e("em",[t._v("Azure Cosmos DB")]),t._v(". When prompted to select an API option, please choose "),e("em",[t._v("Core (SQL) - Recommended")]),t._v(".")]),t._v(" "),e("p",[e("img",{attrs:{src:s(437),alt:"Cosmos DB API",title:"Cosmos DB API options"}})]),t._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),e("p",[t._v("üìù As you might already know, Comsos DB supports a variety of APIs that you can use, depending on your use case. You can e.g. use the "),e("em",[t._v("MongoDB")]),t._v(" API - as the "),e("em",[t._v("Cosmos DB Core API")]),t._v(" - for storing documents, take the "),e("em",[t._v("Cassandra")]),t._v(" API, if you have to deal with timeseries oriented data or "),e("em",[t._v("Gremlin")]),t._v(", if you want to store the data in a graph with "),e("em",[t._v("vertices")]),t._v(" and "),e("em",[t._v("edges")]),t._v(". You can find out more about all the options (and when to choose which API) in the official documentation: "),e("a",{attrs:{href:"https://docs.microsoft.com/azure/cosmos-db/choose-api",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://docs.microsoft.com/azure/cosmos-db/choose-api"),e("OutboundLink")],1),t._v(".")])]),t._v(" "),e("p",[t._v("On the wizard, please choose/enter the following parameters:")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("Option Name")]),t._v(" "),e("th",[t._v("Value")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[e("em",[t._v("Resource Group")])]),t._v(" "),e("td",[t._v("Create a new resource group called "),e("strong",[t._v("rg-cosmos-challenge")])])]),t._v(" "),e("tr",[e("td",[e("em",[t._v("Account Name")])]),t._v(" "),e("td",[t._v("Enter a globally unique account name, like "),e("strong",[t._v("azdc-cosmos-challenge")])])]),t._v(" "),e("tr",[e("td",[e("em",[t._v("Location")])]),t._v(" "),e("td",[t._v("West Europe")])]),t._v(" "),e("tr",[e("td",[e("em",[t._v("Capacity mode")])]),t._v(" "),e("td",[e("strong",[t._v("Serverless")]),t._v(" (we use the serverless option, because it's the cheapest option for development/test purposes)")])])])]),t._v(" "),e("p",[e("img",{attrs:{src:s(438),alt:"Cosmos DB Create Wizard",title:"Cosmos DB Create Wizard"}})]),t._v(" "),e("p",[t._v("Leave all other options as suggested by the wizard and finally click "),e("em",[t._v("Create")]),t._v(". After approximately 4-8 minutes, the database account has been created. Please go to the resource as we now need to add the database and containers for our data.")]),t._v(" "),e("h4",{attrs:{id:"create-a-database-and-containers"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#create-a-database-and-containers"}},[t._v("#")]),t._v(" Create a Database and Containers")]),t._v(" "),e("p",[t._v("The most convenient way to add a database and containers to a CosmosDB account is the "),e("em",[t._v("Data Explorer")]),t._v(". You can find the option in the context menu of the Comsos DB account overview in the Azure Portal. We now need to create two container, so please go to the "),e("em",[t._v("Data Explorer")]),t._v(" and click on "),e("em",[t._v("New Container")]),t._v(" in the toolbar.")]),t._v(" "),e("p",[e("img",{attrs:{src:s(439),alt:"Create a new container in the data explorer",title:"Create Container"}})]),t._v(" "),e("h4",{attrs:{id:"container-customer"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#container-customer"}},[t._v("#")]),t._v(" Container: Customer")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("Option Name")]),t._v(" "),e("th",[t._v("Value")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[e("em",[t._v("Database id")])]),t._v(" "),e("td",[t._v("Select the option "),e("em",[t._v("Create new")]),t._v(" and enter the name "),e("em",[t._v("AzDCdb")]),t._v(". With this first container, we also create the database.")])]),t._v(" "),e("tr",[e("td",[e("em",[t._v("Container id")])]),t._v(" "),e("td",[t._v("customer")])]),t._v(" "),e("tr",[e("td",[e("em",[t._v("Partition key")])]),t._v(" "),e("td",[t._v("/customerId")])])])]),t._v(" "),e("p",[t._v("Click "),e("em",[t._v("Ok")]),t._v(" and when the operation has finished, go to the "),e("em",[t._v("Settings")]),t._v(" view of the "),e("em",[t._v("customer")]),t._v(" container in the "),e("em",[t._v("Data Explorer")]),t._v(" and adjust the "),e("em",[t._v("Indexing Policy")]),t._v(". Copy the following JSON document in the editor and click "),e("em",[t._v("Save")]),t._v(" in the toolbar:")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"indexingMode"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"consistent"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"automatic"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"includedPaths"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"path"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/*"')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"excludedPaths"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"path"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/title/?"')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"path"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/firstName/?"')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"path"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/lastName/?"')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"path"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/emailAddress/?"')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"path"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/phoneNumber/?"')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"path"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/creationDate/?"')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"path"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/addresses/*"')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"path"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/\\"_etag\\"/?"')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),e("p",[t._v("üìù Why are we adjusting the indexing policy? We'll come back to that point later. Just be a little bit patient.")])]),t._v(" "),e("h4",{attrs:{id:"container-product"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#container-product"}},[t._v("#")]),t._v(" Container: Product")]),t._v(" "),e("p",[t._v("Create a "),e("code",[t._v("product")]),t._v(" container similar to the one previously created. Here are the attributes:")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("Option Name")]),t._v(" "),e("th",[t._v("Value")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[e("em",[t._v("Database id")])]),t._v(" "),e("td",[t._v("Select the option "),e("em",[t._v("Use existing")]),t._v(" and select "),e("em",[t._v("AzDCdb")]),t._v(".")])]),t._v(" "),e("tr",[e("td",[e("em",[t._v("Container id")])]),t._v(" "),e("td",[t._v("product")])]),t._v(" "),e("tr",[e("td",[e("em",[t._v("Partition key")])]),t._v(" "),e("td",[t._v("/categoryId")])])])]),t._v(" "),e("p",[t._v("For this container, there is no need to adjust the indexing policy - just leave the default settings.")]),t._v(" "),e("p",[t._v("After you have created the database and the containers, the "),e("em",[t._v("Data Explorer")]),t._v(" should look like that:")]),t._v(" "),e("p",[e("img",{attrs:{src:s(267),alt:"Create a new container in the data explorer",title:"Create Container"}})]),t._v(" "),e("p",[t._v("Now we are ready to add data. You can move on to "),e("a",{attrs:{href:"#add-and-query-data"}},[t._v("Add and query data")])]),t._v(" "),e("h3",{attrs:{id:"option-2-azure-bicep"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#option-2-azure-bicep"}},[t._v("#")]),t._v(" Option 2: Azure Bicep")]),t._v(" "),e("p",[t._v("You can run the following commands on your local machine or in the Azure Cloud Shell. If Azure Bicep isn't installed already, simply add it via the Azure CLI (please choose a unique name for the account and replace "),e("code",[t._v("<REPLACE_WITH_ACCOUNT_NAME>")]),t._v(" with it):")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("$ az bicep "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#only needed, if bicep isn't present in the environment")]),t._v("\n\n$ "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" day3/challenges/cosmosdb\n\n$ az group create "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" rg-cosmos-challenge "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--location")]),t._v(" westeurope\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"id"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/rg-cosmos-challenge"')]),t._v(",\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"location"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"westeurope"')]),t._v(",\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"managedBy"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" null,\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"rg-cosmos-challenge"')]),t._v(",\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"properties"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"provisioningState"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Succeeded"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(",\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"tags"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" null,\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"type"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Microsoft.Resources/resourceGroups"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n$ az deployment group create "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-f")]),t._v(" cosmos.bicep "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-g")]),t._v(" rg-cosmos-challenge "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--parameters")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("cosmosDbAccountName")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("REPLACE_WITH_ACCOUNT_NAME"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"id"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/rg-cosmos-challenge/providers/Microsoft.Resources/deployments/cosmos"')]),t._v(",\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"location"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" null,\n  "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"name"')]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"cosmos"')]),t._v(",\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("After approximately 8-10 minutes, the Cosmos DB account, database and the containers ("),e("em",[t._v("product")]),t._v(" and "),e("em",[t._v("customer")]),t._v(") have been created and are ready to be used. Open the account in the Azure Portal and navigate to the "),e("em",[t._v("Data Explorer")]),t._v(". It should look like similar to that:")]),t._v(" "),e("p",[e("img",{attrs:{src:s(267),alt:"Create a new container in the data explorer",title:"Create Container"}})]),t._v(" "),e("p",[t._v("Let's add data to the two containers.")]),t._v(" "),e("h2",{attrs:{id:"add-and-query-data"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#add-and-query-data"}},[t._v("#")]),t._v(" Add and query data")]),t._v(" "),e("p",[t._v("Now, it's time to add data to the "),e("em",[t._v("customer")]),t._v(" and "),e("em",[t._v("product")]),t._v(" containers. There a two datasets that have been prepared for you.")]),t._v(" "),e("h3",{attrs:{id:"customer-dataset"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#customer-dataset"}},[t._v("#")]),t._v(" Customer Dataset")]),t._v(" "),e("p",[t._v("The "),e("em",[t._v("customer")]),t._v(" dataset contains of two types of objects that we put in the same container: "),e("strong",[t._v("customer")]),t._v(" and "),e("strong",[t._v("salesOrder")]),t._v('. Wait...two object types in the same container? You learned that when dealing with data in a (relational) database, the data should always be normalized and that it\'s best to have one object type in one table! "This is totally against that principle", you might think.')]),t._v(" "),e("p",[t._v('Yes, you are right - in a relational environment. But here, we are working with a NoSQL database and things are a little bit different. Mixing object types in one container is totally fine (and even a best practice in terms of performance). In this non-relational world, you also tend to follow the "de-normalization" principle. That means that data duplication, embedding etc. is not only possible, but encouraged. You optimize data models to make sure that all the required data is ready to be served by queries.')]),t._v(" "),e("h4",{attrs:{id:"customer-data"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#customer-data"}},[t._v("#")]),t._v(" Customer Data")]),t._v(" "),e("p",[t._v("Sample object from the container:")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"id"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0012D555-C7DE-4C4B-B4A4-2E8A6B8E1161"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"type"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"customer"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"customerId"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0012D555-C7DE-4C4B-B4A4-2E8A6B8E1161"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"title"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"firstName"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Franklin"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"lastName"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Ye"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"emailAddress"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"franklin9@adventure-works.com"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"phoneNumber"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1 (11) 500 555-0139"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"creationDate"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2014-02-05T00:00:00"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"addresses"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"addressLine1"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1796 Westbury Dr."')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"addressLine2"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"city"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Melton"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"state"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"VIC"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"country"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"AU"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"zipCode"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"3337"')]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"password"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"hash"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"GQF7qjEgMl3LUppoPfDDnPtHp1tXmhQBw0GboOjB8bk="')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"salt"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"12C0F5A5"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"salesOrderCount"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("A customer document has a property "),e("code",[t._v("type")]),t._v(" set to "),e("em",[t._v("customer")]),t._v(" and contains several properties like "),e("code",[t._v("firstName")]),t._v(", "),e("code",[t._v("lastName")]),t._v(", "),e("code",[t._v("emailAddress")]),t._v(" etc. You can see, that it also uses document embedding for "),e("code",[t._v("addresses")]),t._v(" - the property is an array, so you can add multiple addresses to one customer.")]),t._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("When to use embedding? When to use referencing?")]),t._v(" "),e("p",[t._v("üìù To model relations in a document-oriented database, you have two choices: embedding and referencing. But which should you choose when?")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("Embedding")]),t._v(" "),e("th",[t._v("Referencing")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("1:1 relationship")]),t._v(" "),e("td",[t._v("1:many relationship (especially if unbounded)")])]),t._v(" "),e("tr",[e("td",[t._v("1:few relationship")]),t._v(" "),e("td",[t._v("Many:many relationship")])]),t._v(" "),e("tr",[e("td",[t._v("Related items are queried or updated together")]),t._v(" "),e("td",[t._v("Related items are queried or updated independently")])])])])]),t._v(" "),e("p",[t._v("The partition key of the container has been set to "),e("code",[t._v("/customerId")]),t._v(", so each customer is placed in its own logical partition. With that approach, we achive the best distribution of data in terms of horizontal scaling and will never hit any storage limits - so we are prepared for massive growth of the data/application. On the other hand, this is not the best way when we want to search within our customer base, because we will definitely have cross-partition queries and they will consume more and more RUs as the data grows. How to deal with such a situation is discussed later in the challenge.")]),t._v(" "),e("h4",{attrs:{id:"salesorder-data"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#salesorder-data"}},[t._v("#")]),t._v(" SalesOrder Data")]),t._v(" "),e("p",[t._v("Sample object from the container:")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"id"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"091F884C-DC00-4422-9B89-3438B22DEF07"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"type"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"salesOrder"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"customerId"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0012D555-C7DE-4C4B-B4A4-2E8A6B8E1161"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"orderDate"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2014-03-03T00:00:00"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"shipDate"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2014-03-10T00:00:00"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"details"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"sku"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"TT-M928"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"name"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Mountain Tire Tube"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"price"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("4.99")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"quantity"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"sku"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"PK-7098"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"name"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Patch Kit/8 Patches"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"price"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.29")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"quantity"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"sku"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"TI-M267"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"name"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"LL Mountain Tire"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"price"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("24.99")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"quantity"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("The salesorder object is similar to the customer object ("),e("code",[t._v("type")]),t._v(" is set to "),e("em",[t._v("salesOrder")]),t._v("). It has properties that you would expect for a sales order like "),e("code",[t._v("orderDate")]),t._v(", "),e("code",[t._v("shipDate")]),t._v(", "),e("code",[t._v("customerId")]),t._v(" etc. Also, embedding is used to save the line items of the order.")]),t._v(" "),e("p",[t._v("As these objects are stored in the same collection as the customers ("),e("code",[t._v("customer")]),t._v(" collection), the partition key is also set to "),e("code",[t._v("customerId")]),t._v(". This has a huge advantage over storing the sales orders in a separate collection: you can query both customer and the corresponding sales orders in one query - and all items queried lie in the same logical thus physical partition. Queries are super fast and - from a relational standpoint - you avoid costly JOINs over several tables or multiple queries at all.")]),t._v(" "),e("p",[e("a",{attrs:{href:"https://github.com/azuredevcollege/trainingdays/tree/master/day3/challenges/fixtures/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Download the whole customer dataset here."),e("OutboundLink")],1)]),t._v(" "),e("h3",{attrs:{id:"product-dataset"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#product-dataset"}},[t._v("#")]),t._v(" Product Dataset")]),t._v(" "),e("p",[t._v("The product dataset contains just one object type: "),e("code",[t._v("product")]),t._v(". It simply stores the information for each product like "),e("code",[t._v("name")]),t._v(", "),e("code",[t._v("price")]),t._v(", "),e("code",[t._v("categoryName")]),t._v(". The collection is partitioned by "),e("code",[t._v("/categoryId")]),t._v(", so products are logically grouped by and can be queried via category.")]),t._v(" "),e("h4",{attrs:{id:"product-data"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#product-data"}},[t._v("#")]),t._v(" Product Data")]),t._v(" "),e("p",[t._v("Here's a sample object from the container:")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"id"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"9190229B-1372-4997-8F64-5B3E7A2459C5"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"categoryId"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"86F3CBAB-97A7-4D01-BABB-ADEFFFAED6B4"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"categoryName"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Accessories, Tires and Tubes"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"sku"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"TT-M928"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"name"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Mountain Tire Tube"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"description"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"The product called \\"Mountain Tire Tube\\""')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"price"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("4.99")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"tags"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"id"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"66D8EA21-E1F0-471C-A17F-02F3B149D6E6"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"name"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Tag-83"')]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"id"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"6FB11EB9-319C-431C-89D7-70113401D186"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"name"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Tag-154"')]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"id"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"8AAFD985-8BCE-4FA8-85A2-2CA67D9DF8E6"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"name"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Tag-172"')]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"id"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"A4D9E596-B630-4792-BDD1-7D6459827820"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"name"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Tag-164"')]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[e("a",{attrs:{href:"https://github.com/azuredevcollege/trainingdays/tree/master/day3/challenges/fixtures/cosmosdb/product.json",target:"_blank",rel:"noopener noreferrer"}},[t._v("Download the product dataset here"),e("OutboundLink")],1)]),t._v(" "),e("h3",{attrs:{id:"upload-the-datasets"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#upload-the-datasets"}},[t._v("#")]),t._v(" Upload the datasets")]),t._v(" "),e("p",[t._v("To add the datasets to Cosmos DB, go to the "),e("em",[t._v("Data Explorer")]),t._v(" and first open the "),e("em",[t._v("Items")]),t._v(" menu item of the "),e("em",[t._v("customer")]),t._v(" container. When the tab appears, you'll see an "),e("em",[t._v("Upload Item")]),t._v(" button in the toolbar. Click on that button, then select the "),e("em",[t._v("customer.json")]),t._v(" file that you previously downloaded and click "),e("em",[t._v("Upload")]),t._v(".")]),t._v(" "),e("p",[e("img",{attrs:{src:s(440),alt:"Upload data to a container in the data explorer",title:"Upload data"}})]),t._v(" "),e("p",[t._v("Do the same with the "),e("em",[t._v("product.json")]),t._v(" file for the "),e("em",[t._v("product")]),t._v(" collection.")]),t._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),e("p",[t._v("üìù Depending on your network speed and latency, the uploads should take about 2-4 minutes.")])]),t._v(" "),e("h3",{attrs:{id:"queries"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#queries"}},[t._v("#")]),t._v(" Queries")]),t._v(" "),e("p",[t._v("Let's work with the data and execute some queries against the two containers.")]),t._v(" "),e("h4",{attrs:{id:"simple-queries"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#simple-queries"}},[t._v("#")]),t._v(" Simple queries")]),t._v(" "),e("p",[t._v("First, let's issue queries in the "),e("em",[t._v("customer")]),t._v(" container where we have customer and sales order objects. Let's start with a few simple queries.")]),t._v(" "),e("p",[t._v("Therefor, go to the Data Explorer, open the "),e("em",[t._v("Items")]),t._v(" menu item of the "),e("em",[t._v("customer")]),t._v(" container and click on "),e("em",[t._v("New SQL Query")]),t._v(" in the toolbar.")]),t._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),e("p",[t._v("üìù You can open the "),e("em",[t._v("Data Explorer")]),t._v(" as a separate window via the toolbar.")])]),t._v(" "),e("p",[e("img",{attrs:{src:s(441),alt:"Create new SQL query in Data Explorer",title:"New SQL Query"}})]),t._v(" "),e("p",[t._v("In the newly created tab, enter the following SQL command and click "),e("em",[t._v("Execute")]),t._v(".")]),t._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" c\n")])])]),e("p",[t._v("As you can see in the "),e("em",[t._v("Results")]),t._v(" tab, Cosmos DB returns a set of documents, that live in the "),e("em",[t._v("customer")]),t._v(" container. It returns a paged resultset, showing documents in batches of 100 items.")]),t._v(" "),e("p",[e("img",{attrs:{src:s(442),alt:"Results of a SQL query in Data Explorer",title:"SQL Query resultset"}})]),t._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),e("p",[t._v("üìù Have a look at the "),e("em",[t._v("Query Stats")]),t._v(" tab! Here you can see what amount of RUs have been consumed by the query (and also other statistics).")])]),t._v(" "),e("p",[t._v("As you can see in the result document, there is a bunch of properties, that have a special meaning for documents stored via the SQL API, e.g. "),e("em",[t._v("id")]),t._v(", _"),e("em",[t._v("rid")]),t._v(", _"),e("em",[t._v("ts")]),t._v(" etc. All properties are described in the following table (excerpt from the official Comsos DB documentation):")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("Property")]),t._v(" "),e("th",[t._v("Description")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[e("em",[t._v("id")])]),t._v(" "),e("td",[t._v("Required. It is a user settable property. It is the unique attribute that identifies the document, that is, no two documents share the same ID "),e("strong",[t._v("within a logical partition")]),t._v(". Partition and ID uniquely identifies an item in the database. The id field must not exceed 255 characters.")])]),t._v(" "),e("tr",[e("td",[t._v("_"),e("em",[t._v("rid")])]),t._v(" "),e("td",[t._v("It is a system generated property. The resource ID (_rid) is a unique identifier that is also hierarchical per the resource stack on the resource model. It is used internally for placement and navigation of the document resource.")])]),t._v(" "),e("tr",[e("td",[t._v("_"),e("em",[t._v("ts")])]),t._v(" "),e("td",[t._v("It is a system generated property. It specifies the last updated timestamp of the resource. The value is a timestamp.")])]),t._v(" "),e("tr",[e("td",[t._v("_"),e("em",[t._v("self")])]),t._v(" "),e("td",[t._v("It is a system generated property. It is the unique addressable URI for the resource.")])]),t._v(" "),e("tr",[e("td",[t._v("_"),e("em",[t._v("etag")])]),t._v(" "),e("td",[t._v("It is a system generated property that specifies the resource etag required for "),e("a",{attrs:{href:"https://docs.microsoft.com/azure/cosmos-db/database-transactions-optimistic-concurrency#optimistic-concurrency-control",target:"_blank",rel:"noopener noreferrer"}},[t._v("optimistic concurrency control"),e("OutboundLink")],1),t._v(".")])]),t._v(" "),e("tr",[e("td",[t._v("_"),e("em",[t._v("attachments")])]),t._v(" "),e("td",[t._v("It is a system generated property that specifies the addressable path for the attachments resource.")])]),t._v(" "),e("tr",[e("td",[e("em",[t._v("ttl")])]),t._v(" "),e("td",[t._v("Azure Cosmos DB provides the ability to delete items automatically from a container after a certain time period. By default, you can set "),e("em",[t._v("time to live")]),t._v(" or "),e("em",[t._v("TTL")]),t._v(" at the container level and override the value on a per-item basis. Use the "),e("em",[t._v("ttl")]),t._v(" property for setting the per-item time period. More on that "),e("a",{attrs:{href:"https://docs.microsoft.com/azure/cosmos-db/time-to-live",target:"_blank",rel:"noopener noreferrer"}},[t._v("here"),e("OutboundLink")],1),t._v(".")])])])]),t._v(" "),e("p",[t._v("Let's execute another query to determine the amount of documents stored in the "),e("em",[t._v("customer")]),t._v(" collection.")]),t._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("COUNT")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" numDocuments "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" c\n")])])]),e("p",[t._v("The result should produce a JSON document like this:")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"numDocuments"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("50584")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),e("p",[t._v("You can also query the value directly by adding the "),e("code",[t._v("VALUE")]),t._v(" keyword:")]),t._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VALUE")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("COUNT")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" c\n")])])]),e("p",[t._v("Result:")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("50584")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),e("h4",{attrs:{id:"indexing-and-partition-aware-queries"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#indexing-and-partition-aware-queries"}},[t._v("#")]),t._v(" Indexing and Partition-Aware Queries")]),t._v(" "),e("p",[t._v("In Azure Cosmos DB, documents are automatically indexed without having to define a schema or create any secondary indexes. Every document that is stored in Cosmos DB is converted to a tree object, so that you can reference each property via its path.")]),t._v(" "),e("p",[e("img",{attrs:{src:s(443),alt:"Tree respresentation in Cosmos DB",title:"Propery tree"}})]),t._v(" "),e("p",[t._v("E.g., you can access the "),e("em",[t._v("city")]),t._v(" property of the first address of a customer object via "),e("code",[t._v("/addresses/0/city")]),t._v(".")]),t._v(" "),e("p",[t._v("Adding an index can significantly reduce the query time and consumed RUs, but can also be expensive when adding or updating a document, because after each action, the index has to be recalculated/recreated for the document data. So, if you have write-intensive workloads, it is better to tweak the indexing policy.")]),t._v(" "),e("p",[t._v("Let's have a look at the "),e("em",[t._v("customer")]),t._v(" document. The indexing policy has been adjusted to NOT(!) index fields like "),e("em",[t._v("firstName")]),t._v(", "),e("em",[t._v("title")]),t._v(", "),e("em",[t._v("addresses")]),t._v(' etc. Adding or updating a customer consumes ~ 8.5 RUs. Using the standard indexing policy (which means all properties will be indexed), the same operation consumes ~13.2 RUs. That\'s about 150% "the price".')]),t._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("Index Types")]),t._v(" "),e("p",[t._v("üìù Cosmos DB supports several index types like "),e("em",[t._v("range")]),t._v(", "),e("em",[t._v("spatial")]),t._v(" (for geo-data) and "),e("em",[t._v("composite indexes")]),t._v(". To learn more about when to use what kind of index, refer to the official documentation: "),e("a",{attrs:{href:"https://docs.microsoft.com/azure/cosmos-db/index-overview",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://docs.microsoft.com/azure/cosmos-db/index-overview"),e("OutboundLink")],1),t._v(".")])]),t._v(" "),e("p",[t._v("You saw that limiting the amount of properties that get indexed is beneficial for storing data. RU cost is significantly reduced. But it has impact on querying data. If you want to use the collection to give users of your application to search and query for any properties, it has the opposite impact. A lot of RUs will be consumed.")]),t._v(" "),e("p",[t._v("Let's demonstrate that. Open a new query tab for the "),e("em",[t._v("customer")]),t._v(" container, issue the following queries and have a look at the "),e("em",[t._v("Query Stats")]),t._v(" tab to see the amount of RUs consumed.")]),t._v(" "),e("div",{staticClass:"language-SQL extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" c "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("firstName "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Franklin"')]),t._v("\n")])])]),e("p",[t._v("The problem here is, that we are querying for a property that is not indexed "),e("strong",[t._v("and")]),t._v(" the query itself is a "),e("em",[t._v("cross-partition")]),t._v(" query. Azure Cosmos DB needs to fan-out the query to all physical partitions of the database. If you have a lot of data in the collection (e.g. 100GB), the cost for such a query will be a lot more expensive, because the amount of physical partitions will grow depending on how much data is stored in a container and thus the number of queries that need to be managed under the hood by the db engine.")]),t._v(" "),e("p",[t._v("Let's add the partition key to the query (means: Cosmos DB knows exactly to which physical partition to send the query to.).")]),t._v(" "),e("div",{staticClass:"language-SQL extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" c "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("firstName "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Franklin"')]),t._v(" \n    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("AND")]),t._v(" c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("customerId "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0012D555-C7DE-4C4B-B4A4-2E8A6B8E1161"')]),t._v("\n")])])]),e("p",[t._v("This is "),e("em",[t._v("much")]),t._v(" better! Now, let's adjust the indexing policy so that all properties will be indexed. Go to the "),e("em",[t._v("Scale & Settings")]),t._v(" menu item of the "),e("em",[t._v("customer")]),t._v(" container and set the indexing policy to:")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"indexingMode"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"consistent"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"automatic"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"includedPaths"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"path"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/*"')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"excludedPaths"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"path"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/\\"_etag\\"/?"')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("Comsos DB needs a few minutes to index the container - now for a query intensive application. Exceute the queries again and have another look at the "),e("em",[t._v("Query Stats")]),t._v(". You'll see a huge improvement in terms of RU cost.")]),t._v(" "),e("p",[t._v("Cross-partition:")]),t._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" c "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("firstName "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Franklin"')]),t._v("\n")])])]),e("p",[t._v("With partition key:")]),t._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" c "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("firstName "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Franklin"')]),t._v(" \n    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("AND")]),t._v(" c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("customerId "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0012D555-C7DE-4C4B-B4A4-2E8A6B8E1161"')]),t._v("\n")])])]),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),e("p",[t._v("üìù You can see, even cross-partition queries profit from proper indexing when executing queries. Nevertheless, you should definitely avoid these kind of queries as the cost grows with the amount of data stored in a container.")])]),t._v(" "),e("h4",{attrs:{id:"can-i-do-relational-joins"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#can-i-do-relational-joins"}},[t._v("#")]),t._v(" Can I do (relational) JOINs?")]),t._v(" "),e("p",[t._v("One of the most discussed topics is how to model relations in Cosmos DB. You already saw one technique how to query related data: embedding. With embedding, you simply add the related data to the document as shown in the "),e("em",[t._v("customer")]),t._v(" object with "),e("em",[t._v("addresses")]),t._v(". When you read a customer document, addresses will automatically be fetched as well, because the information is part of the object itself.")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"id"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0012D555-C7DE-4C4B-B4A4-2E8A6B8E1161"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"type"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"customer"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"customerId"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0012D555-C7DE-4C4B-B4A4-2E8A6B8E1161"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    ...\n    ...\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"creationDate"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2014-02-05T00:00:00"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"addresses"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"addressLine1"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1796 Westbury Dr."')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"addressLine2"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"city"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Melton"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"state"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"VIC"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"country"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"AU"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"zipCode"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"3337"')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("This is a good practice, if you have 1:few relationships. If you have unbounded collections/relations, this is considered an anti-pattern, because storing and querying such a document is becoming expensive (also consider: you have an upper limit regarding the document size, which is currently set to "),e("em",[t._v("2MB")]),t._v(".).")]),t._v(" "),e("p",[t._v("Another technqiue is to place the related data in the same container, with the same partion key, so that you can query all data at once with a single command. Since all objects are placed in the same logical partition, commands consume the least amount of RUs possible and perform very well.")]),t._v(" "),e("h5",{attrs:{id:"example"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#example"}},[t._v("#")]),t._v(" Example")]),t._v(" "),e("p",[t._v("Consider having customers and order objects in your application, that are placed in "),e("strong",[t._v("separate containers")]),t._v(". To query a specific customer and all related orders, you would first issue a query that gets the customer and a second query that retrieves all order objects. In a relational database, you would just use one SQL query with a JOIN statement over these two tables.")]),t._v(" "),e("p",[t._v("In Comsos DB, just put the objects in the same container and with the same partition key and fetch both object types with one single query. No need to have costly JOINs or multiple select statements.")]),t._v(" "),e("p",[t._v("The current sample dataset "),e("code",[t._v("customer")]),t._v(" is designed like that, so let's query for those objects.")]),t._v(" "),e("h5",{attrs:{id:"query-for-a-customer-object"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#query-for-a-customer-object"}},[t._v("#")]),t._v(" Query for a customer object")]),t._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" c "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("customerId "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0012D555-C7DE-4C4B-B4A4-2E8A6B8E1161"')]),t._v(" \n  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("AND")]),t._v(" c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"customer"')]),t._v("\n")])])]),e("h5",{attrs:{id:"query-for-the-sales-orders-of-that-customer"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#query-for-the-sales-orders-of-that-customer"}},[t._v("#")]),t._v(" Query for the sales orders of that customer")]),t._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" c "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("customerId "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0012D555-C7DE-4C4B-B4A4-2E8A6B8E1161"')]),t._v(" \n  "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("AND")]),t._v(" c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"salesOrder"')]),t._v("\n")])])]),e("h5",{attrs:{id:"query-for-the-customer-as-well-as-for-the-sales-orders-in-one-statement"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#query-for-the-customer-as-well-as-for-the-sales-orders-in-one-statement"}},[t._v("#")]),t._v(" Query for the customer, as well as for the sales orders in one statement")]),t._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" c "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("customerId "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"0012D555-C7DE-4C4B-B4A4-2E8A6B8E1161"')]),t._v("\n")])])]),e("p",[t._v("As you can see in the query stats: it's fast and cheap in terms of RUs cost.")]),t._v(" "),e("h4",{attrs:{id:"aggerations-functions-etc"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#aggerations-functions-etc"}},[t._v("#")]),t._v(" Aggerations, Functions etc")]),t._v(" "),e("p",[t._v("Of course, Cosmos DB also supports aggregations, functions, geo-spatial data handling, triggers, subqueries, and much more. To give you an impression, what is possible, here are a few queries you can try on the "),e("em",[t._v("product")]),t._v(" and "),e("em",[t._v("customer")]),t._v(" container.")]),t._v(" "),e("h5",{attrs:{id:"get-the-average-price-of-products-by-category"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#get-the-average-price-of-products-by-category"}},[t._v("#")]),t._v(" Get the average price of products by category")]),t._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("categoryName "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" Category"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("AVG")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("price"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" avgPrice "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" c "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("GROUP")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("categoryName\n")])])]),e("h5",{attrs:{id:"get-the-average-price-of-products-by-category-within-a-category"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#get-the-average-price-of-products-by-category-within-a-category"}},[t._v("#")]),t._v(" Get the average price of products by category - within a category")]),t._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("categoryName "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" Category"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("AVG")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("price"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" avgPrice "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" c \n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("categoryId "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"75BF1ACB-168D-469C-9AA3-1FD26BB4EA4C"')]),t._v(" \n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("GROUP")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("categoryName\n")])])]),e("h5",{attrs:{id:"get-the-top-10-customers-by-orders-customer-container"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#get-the-top-10-customers-by-orders-customer-container"}},[t._v("#")]),t._v(" Get the top 10 customers by orders - "),e("em",[t._v("customer")]),t._v(" container")]),t._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("TOP")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(" c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("firstName"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("lastName"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("salesOrderCount "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" c\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'customer'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" c"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("salesOrderCount "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DESC")]),t._v("\n")])])]),e("h2",{attrs:{id:"use-the-cosmos-db-change-feed"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#use-the-cosmos-db-change-feed"}},[t._v("#")]),t._v(" Use the Cosmos DB Change Feed")]),t._v(" "),e("h3",{attrs:{id:"why-to-use-it"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#why-to-use-it"}},[t._v("#")]),t._v(" Why to use it?")]),t._v(" "),e("p",[t._v("The Azure Cosmos DB change feed enables efficient processing of large datasets with a high volume of writes. The change feed also offers an alternative to querying an entire dataset to identify what has changed. This section focuses on giving an overview of the Cosmos DB change feed, how to consume it and a sample where an Azure Function consumes the message from the change feed.")]),t._v(" "),e("p",[t._v("Azure Cosmos DB is a service that is well-suited for streaming applications like IoT, gaming, but also retail and operational logging applications. It is often used in microservices-based application due to the features it offers with the change feed. A common design pattern in all these applications is to use changes to the data to trigger additional actions. Examples of additional actions include:")]),t._v(" "),e("ul",[e("li",[t._v("Triggering a notification or a call to an API, when an item is inserted or updated.")]),t._v(" "),e("li",[t._v("Real-time stream processing for IoT or real-time analytics processing on operational data.")]),t._v(" "),e("li",[t._v("Data movement such as synchronizing with a cache, a search engine, a data\nwarehouse, or cold storage.")])]),t._v(" "),e("p",[t._v("The change feed in Azure Cosmos DB enables you to build efficient and scalable solutions for each of these patterns, as shown in the following image:")]),t._v(" "),e("p",[e("img",{attrs:{src:s(444),alt:"Overview of event processing using Azure Cosmos DB Change Feed",title:"Event Processing with Comsos DB"}})]),t._v(" "),e("p",[t._v("For event processing and notifications the Azure Cosmos DB change feed can simplify scenarios that need to trigger a notification or send a call to an API based on a certain event.")]),t._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),e("p",[t._v("üìù Reagarding some patterns and best practices for change feed, you can read more details "),e("a",{attrs:{href:"https://docs.microsoft.com/azure/cosmos-db/change-feed-design-patterns",target:"_blank",rel:"noopener noreferrer"}},[t._v("here"),e("OutboundLink")],1),t._v(".")])]),t._v(" "),e("h3",{attrs:{id:"what-does-it-support"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#what-does-it-support"}},[t._v("#")]),t._v(" What does it support?")]),t._v(" "),e("p",[t._v("The following APIs are supported:")]),t._v(" "),e("ul",[e("li",[t._v("SQL API")]),t._v(" "),e("li",[t._v("MongoDB API")]),t._v(" "),e("li",[t._v("Cassandra API")]),t._v(" "),e("li",[t._v("Gremlin API")])]),t._v(" "),e("p",[t._v("What's not supported:")]),t._v(" "),e("ul",[e("li",[t._v("Table API")])]),t._v(" "),e("h3",{attrs:{id:"how-to-consume-the-change-feed"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#how-to-consume-the-change-feed"}},[t._v("#")]),t._v(" How to consume the Change Feed?")]),t._v(" "),e("p",[t._v("In this challenge we will use an Azure Function hence providing the simplest way to connect to the change feed. You can create small reactive Azure Function that will be automatically triggered on each new event in your Azure Cosmos\ncontainer's change feed.")]),t._v(" "),e("p",[t._v("As this is an introduction, we will focus on the Azure Function sample. If you are interested to read about other options like the ChangeFeed Processor, you can get more details "),e("a",{attrs:{href:"https://docs.microsoft.com/azure/cosmos-db/change-feed-processor",target:"_blank",rel:"noopener noreferrer"}},[t._v("here"),e("OutboundLink")],1),t._v(".")]),t._v(" "),e("p",[e("img",{attrs:{src:s(445),alt:"Azure Function processing events from the Change Feed",title:"Change Feed Overview"}})]),t._v(" "),e("p",[t._v("With the change feed feature, you get a consistent, in-order stream of changes within the logical partitions of your container.")]),t._v(" "),e("p",[e("img",{attrs:{src:s(446),alt:"Overview Change Feed with multiple consumers",title:"Customer Container Change Feed"}})]),t._v(" "),e("h3",{attrs:{id:"sample-create-a-customerview-collection-for-query-optimized-access-to-customer-data"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#sample-create-a-customerview-collection-for-query-optimized-access-to-customer-data"}},[t._v("#")]),t._v(" Sample: Create a customerView collection for query-optimized access to Customer data")]),t._v(" "),e("p",[t._v("Let's assume the following scenario: Your application is used to query for customers based on the country the customer is located. Your sales colleagues are organized in sales areas (countries), so it's a valid scenario for them. Unfortunately, the "),e("code",[t._v("customer")]),t._v(" container is not prepared for such queries, because these queries would result in cross-partition statements. As we learned, this will effect the performance and cost of our "),e("code",[t._v("customer")]),t._v(" container. In the following sample we will create an item in the "),e("code",[t._v("customer")]),t._v(" container which is triggering a message to the change feed consumer - in this case an Azure Function. The consumer replicates the item from the change feed to another container called "),e("code",[t._v("customerView")]),t._v(" which is partitioned by the country ("),e("code",[t._v("/area")]),t._v(") and is therefor optimized for the queries of the sales colleagues.")]),t._v(" "),e("p",[t._v("You have two options to deploy the collection: either via the Azure Portal or via a "),e("em",[t._v("bicep")]),t._v(" template.")]),t._v(" "),e("h4",{attrs:{id:"option-1-deployment-via-portal"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#option-1-deployment-via-portal"}},[t._v("#")]),t._v(" Option 1: Deployment via Portal")]),t._v(" "),e("p",[t._v("See the description of how to deploy a Cosmos DB via Portal from above or use the existing one.\nCreate a collection "),e("code",[t._v("customerView")]),t._v(" using as partition key "),e("code",[t._v("/area")]),t._v(".")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("Option Name")]),t._v(" "),e("th",[t._v("Value")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[e("em",[t._v("Database id")])]),t._v(" "),e("td",[t._v("Select the option "),e("em",[t._v("Use existing")]),t._v(" and select "),e("em",[t._v("AzDCdb")]),t._v(".")])]),t._v(" "),e("tr",[e("td",[e("em",[t._v("Container id")])]),t._v(" "),e("td",[t._v("customerView")])]),t._v(" "),e("tr",[e("td",[e("em",[t._v("Partition key")])]),t._v(" "),e("td",[t._v("/area")])])])]),t._v(" "),e("h4",{attrs:{id:"option-2-deployment-via-bicep-file"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#option-2-deployment-via-bicep-file"}},[t._v("#")]),t._v(" Option 2: Deployment via Bicep File")]),t._v(" "),e("p",[t._v("There is a bicep file prepared for you in the "),e("code",[t._v("cosmosdb")]),t._v(" folder which lets you automatically deploy the Cosmos DB "),e("code",[t._v("customerView")]),t._v(" container to the existing Cosmos DB Account.")]),t._v(" "),e("p",[t._v("Go ahead and open up a commandline window and use the following command:")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" trainingdays/day3/challenges/cosmosdb\naz deployment group create "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-g")]),t._v(" rg-cosmos-challenge --template-file addcustomerviewcontainer.bicep "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--parameters")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("cosmosDbAccountName")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("REPLACE_WITH_ACCOUNT_NAME"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),e("h4",{attrs:{id:"purpose-of-the-azure-function"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#purpose-of-the-azure-function"}},[t._v("#")]),t._v(" Purpose of the Azure Function")]),t._v(" "),e("p",[t._v("The function listens to every change on the "),e("code",[t._v("customer")]),t._v(" collection and pushes customer documents that have "),e("code",[t._v("Germany / DE")]),t._v(" or "),e("code",[t._v("France / FR")]),t._v(" as country code in their address to the "),e("code",[t._v("customerView")]),t._v(" collection. Go ahead and open up your Visual Studio Code in the function folder using the following folder path:")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" trainingdays/day3/challenges/cosmosdb/func\ncode "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n")])])]),e("p",[t._v("Create a file called "),e("code",[t._v("local.settings.json")]),t._v(" in the folder "),e("em",[t._v("day3/challenges/cosmosdb/func")]),t._v(" with the following content and adjust the connection string to the CosmosDB account. Also, create a storage account in the Azure Portal and replace the storage account connection string in the settings file:")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"IsEncrypted"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"Values"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"AzureWebJobsStorage"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"<ADD STORAGE ACCOUNT CONNECTION STRING>"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"FUNCTIONS_WORKER_RUNTIME"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"node"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"myDB_DOCUMENTDB"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"<ADD COSMOSDB CONNECTION STRING>"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),e("p",[t._v("When created, take a look at the "),e("code",[t._v("function.json")]),t._v(" file in the "),e("em",[t._v("CosmosTrigger1")]),t._v(" folder. We set the "),e("code",[t._v("StartFromBeginning")]),t._v(" CosmosDBTrigger attribute in the "),e("code",[t._v("function.json")]),t._v(" to true:")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[t._v('startFromBeginning"'),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n")])])]),e("p",[t._v("This setting tells the function to read the change feed entries "),e("strong",[t._v("from the beginning")]),t._v(" and not just from the point in time where it connects to the change feed - this gives you access to the history of your collection. Running the function, will read and process all changes from the beginning of the change feed.")]),t._v(" "),e("p",[t._v("Now, open up the "),e("code",[t._v("index.js")]),t._v(" file and set a break point next to line 6:")]),t._v(" "),e("div",{staticClass:"language-javascript extra-class"},[e("pre",{pre:!0,attrs:{class:"language-javascript"}},[e("code",[t._v("val"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("type "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'customer'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v("\n")])])]),e("p",[t._v("Let's move on and start the function using the debug mode in VS Code. You will see the function process all entries in the change feed in batches of 100 documents. As you can see in the "),e("code",[t._v("index.js")]),t._v(" file, we only take care of entries where the address is in France or Germany (just to speed things a little bit up).")]),t._v(" "),e("p",[t._v("When the processing has finished, take a look at the "),e("code",[t._v("customerView")]),t._v(" collection. You'll see all customers that are located in Germany and France.")]),t._v(" "),e("p",[t._v("To prove that this process works near real-time, let's go to the portal and insert a new "),e("em",[t._v("item")]),t._v(" into the "),e("code",[t._v("customer")]),t._v(" container (if you want to, set a breakpoint again to see the change arriving at your function):")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"id"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"034C5E4C-EE20-47E2-8637-5CCB02525EDE"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"type"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"customer"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"customerId"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"034C5E4C-EE20-47E2-8637-5CCB02525EDE"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"title"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"firstName"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Jackson"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"lastName"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Frieda"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"emailAddress"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"f.jackson@adventure-works.com"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"phoneNumber"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"1 (11) 500 555-0121"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"creationDate"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"2013-04-12T00:00:00"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"addresses"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"addressLine1"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Roemerplatz 90"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"addressLine2"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"city"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Remchingen"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"state"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"BW"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"country"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"DE"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"zipCode"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"75196"')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"password"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"hash"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ruT19z16403NBEe2S1WlSaA3dUmC4chHgTemAJMU6E4="')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"salt"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"C554EA68"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"salesOrderCount"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("After saving, it should look like this:")]),t._v(" "),e("p",[e("img",{attrs:{src:s(447),alt:"Create a customer item",title:"Create Customer"}})]),t._v(" "),e("p",[t._v("Once the item has been created, the Azure Function gets triggered:")]),t._v(" "),e("p",[e("img",{attrs:{src:s(448),alt:"Set a breakpoint in VS Code",title:"Breakpoint in VS Code"}})]),t._v(" "),e("p",[t._v("As final result we will see the customer - as the country code matches Germany (DE) - in the "),e("code",[t._v("customerView")]),t._v(" Container:")]),t._v(" "),e("p",[e("img",{attrs:{src:s(449),alt:"CustomerView collection with result",title:"customerView collection"}})]),t._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),e("p",[t._v("üìù When using an Azure Function to connect to the Cosmos DB change feed, you'll see a "),e("code",[t._v("leases")]),t._v(" container appear in your database. This is used to track the progress of the Azure Function when processing the feed.")])]),t._v(" "),e("h3",{attrs:{id:"what-have-we-learned-so-far"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#what-have-we-learned-so-far"}},[t._v("#")]),t._v(" What have we learned so far?")]),t._v(" "),e("p",[t._v("We learned about the change feed, when to use it and what APIs are supported. Further Azure Function bindings are a simple way to track the changes which occurred in the CosmosDB. And in the hands-on part, we also added a "),e("code",[t._v("customerView")]),t._v(" container via Portal or via bicep file. In addition we ran the Azure Function code (locally) to listen to every change on the "),e("code",[t._v("customer")]),t._v(" collection where we added a German customer item and replicated the item to the "),e("code",[t._v("customerView")]),t._v(" collection for query-optimized access.")]),t._v(" "),e("h4",{attrs:{id:"optional"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#optional"}},[t._v("#")]),t._v(" Optional")]),t._v(" "),e("p",[t._v("If you want to do more, you can deploy the bicep file "),e("em",[t._v("function.bicep")]),t._v(" using this command and use "),e("em",[t._v("Day 2")]),t._v(" as your "),e("em",[t._v("cheat sheet")]),t._v(" of how to deploy the code towards the Azure Function service.")]),t._v(" "),e("div",{staticClass:"language-shell extra-class"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("az deployment group create "),e("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-g")]),t._v(" rg-cosmos-challenge --template-file function.bicep\n")])])]),e("p",[t._v("For using Cosmos DB in production monitoring is essential, which will be focused on in the next section.")]),t._v(" "),e("h2",{attrs:{id:"monitor-cosmos-db"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#monitor-cosmos-db"}},[t._v("#")]),t._v(" Monitor Cosmos DB")]),t._v(" "),e("p",[t._v("In order to monitor your CosmosDB account, the databases and collections for performance, failures, throtteling, operational health etc. the "),e("em",[t._v("CosmosDB Insights")]),t._v(" workbook is your friend.")]),t._v(" "),e("p",[t._v("You can access the dashboards in the CosmosDB account view and click on "),e("em",[t._v("Insights")]),t._v(' in the context menu under "Monitoring".')]),t._v(" "),e("p",[t._v("Here are a few sample dashboards that help you understand what's going on in your Cosmos DB account.")]),t._v(" "),e("p",[t._v("When you have successfully finished the Change Feed challenge, you should see metrics like the following ones:")]),t._v(" "),e("p",[e("img",{attrs:{src:s(450),alt:"Monitoring Insights in Azure Portal",title:"Portal Insights 1"}}),t._v(" "),e("img",{attrs:{src:s(451),alt:"Monitoring Insights in Azure Portal",title:"Portal Insights 2"}}),t._v(" "),e("img",{attrs:{src:s(452),alt:"Monitoring Insights in Azure Portal",title:"Portal Insights 3"}})]),t._v(" "),e("h2",{attrs:{id:"azure-samples-further-information"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#azure-samples-further-information"}},[t._v("#")]),t._v(" Azure Samples / Further Information")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://docs.microsoft.com/azure/cosmos-db/modeling-data",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://docs.microsoft.com/azure/cosmos-db/modeling-data"),e("OutboundLink")],1),t._v(" - Modelling data")]),t._v(" "),e("li",[e("a",{attrs:{href:"https://docs.microsoft.com/azure/cosmos-db/sql-query-getting-started",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://docs.microsoft.com/azure/cosmos-db/sql-query-getting-started"),e("OutboundLink")],1),t._v(" - SQL API Queries")]),t._v(" "),e("li",[e("a",{attrs:{href:"https://aka.ms/PracticalCosmosDB",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://aka.ms/PracticalCosmosDB"),e("OutboundLink")],1),t._v(" - model a blog platform")]),t._v(" "),e("li",[e("a",{attrs:{href:"https://youtube.com/azurecosmosdb",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://youtube.com/azurecosmosdb"),e("OutboundLink")],1),t._v(" - videos on CosmosDB")]),t._v(" "),e("li",[e("a",{attrs:{href:"https://devblogs.microsoft.com/cosmosdb/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://devblogs.microsoft.com/cosmosdb/"),e("OutboundLink")],1),t._v(" - official CosmosDB blog")]),t._v(" "),e("li",[e("a",{attrs:{href:"https://docs.microsoft.com/azure/cosmos-db/concepts-limits",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://docs.microsoft.com/azure/cosmos-db/concepts-limits"),e("OutboundLink")],1),t._v(" - Service limits")])]),t._v(" "),e("h2",{attrs:{id:"cleanup"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#cleanup"}},[t._v("#")]),t._v(" Cleanup")]),t._v(" "),e("p",[t._v("No clean-up needed this time. We will reuse the Cosmos DB account in the Azure\nCognitive Search challenge. So please, "),e("strong",[t._v("don't delete any of the resources yet")]),t._v(".")]),t._v(" "),e("p",[e("RouterLink",{attrs:{to:"/day3/challenges/00-challenge-baseline.html"}},[t._v("‚óÄ Previous challenge")]),t._v(" | "),e("RouterLink",{attrs:{to:"/day3/"}},[t._v("üîº Day 3")]),t._v(" | "),e("RouterLink",{attrs:{to:"/day3/challenges/02-challenge-sql.html"}},[t._v("Next challenge ‚ñ∂")])],1)])}),[],!1,null,null,null);e.default=r.exports}}]);